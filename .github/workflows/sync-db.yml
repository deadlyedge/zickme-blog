name: Sync Content to Database
on:
  workflow_run:
    workflows: ['Upload Media to Cloudinary']
    types: [completed]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Bun 安装（内置 Node 20 兼容）
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest  # 或 1.1.30

      - name: Install dependencies
        run: bun ci  # 替换 npm ci，速度提升 5-10x

      - name: Sync to Neon
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          bunx prisma generate
          bunx prisma db push
          bunx tsx scripts/sync-content.ts  # tsx 兼容 Bun，比 npx 快

      - name: Retry sync trigger
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://api.github.com/repos/${{ github.repository }}/dispatches'
          method: 'POST'
          customHeaders: '{"Accept": "application/vnd.github.3.json"}'
          data: '{"event_type": "retry-sync"}'
